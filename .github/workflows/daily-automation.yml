name: Daily Excel Processing

on:
  schedule:
    # Runs every day at 9 AM UTC (3 AM CST)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  process-excel:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Adjust based on your needs
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Download Excel file
      env:
        EXCEL_URL: ${{ secrets.EXCEL_URL }}
      run: |
        # Option 1: Download from URL
        if [ -n "$EXCEL_URL" ]; then
          curl -L -o "Direct Query Master List V3.xlsx" "$EXCEL_URL"
        fi
        # Option 2: Use file from repo (if committed)
        # File is already available from checkout
        
    - name: Run Excel processing
      env:
        API_KEY: ${{ secrets.API_KEY }}
        EMAIL_ID: ${{ secrets.EMAIL_ID }}
        API_BASE_URL: https://kata.fortive.com/
        SESSION_ID: ${{ secrets.SESSION_ID }}
        THREAD_ID: ${{ secrets.THREAD_ID }}
      run: |
        # Run the test script (first 10 rows) or full script
        python test_first_10.py
        # For full processing, use: python psp300.py
        
    - name: Upload processed Excel
      uses: actions/upload-artifact@v3
      with:
        name: processed-excel-${{ github.run_number }}
        path: |
          Direct Query Master List V*.xlsx
        retention-days: 30
        
    - name: Upload to cloud storage (optional)
      if: success()
      run: |
        # Example: Upload to Google Drive using rclone
        # curl https://rclone.org/install.sh | sudo bash
        # rclone copy "Direct Query Master List V*.xlsx" gdrive:/Excel-Automation/
        
        # Or use other services:
        # - OneDrive: https://github.com/abraunegg/onedrive
        # - Dropbox: https://github.com/dropbox/dbxcli
        # - AWS S3: aws s3 cp file.xlsx s3://bucket/
        echo "Upload to cloud storage here if needed"
        
    - name: Send success notification
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: ✅ Daily Excel Processing Completed Successfully
        body: |
          Daily Excel processing completed successfully!
          
          Run: ${{ github.run_number }}
          Date: ${{ github.event.repository.updated_at }}
          Duration: ${{ job.duration }}
          
          Check artifacts: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        to: abhay.manikanti@fortive.com
        from: Excel Automation <noreply@github.com>
        
    - name: Send failure notification
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: ❌ Daily Excel Processing FAILED
        body: |
          ⚠️ Daily Excel processing FAILED!
          
          Run: ${{ github.run_number }}
          Error details: Check the logs
          
          View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        to: abhay.manikanti@fortive.com
        from: Excel Automation <noreply@github.com>
